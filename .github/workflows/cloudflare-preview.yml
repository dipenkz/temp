name: Count PR + Commit comments
on:  workflow_dispatch

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  count-comments:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const branch = context.ref.replace('refs/heads/', '');

            let issue = 0, review = 0, commit = 0;

            // --- commit comments (what you see in /commits/branch) ---
            const commitComments = await github.paginate(
              github.rest.repos.listCommentsForCommit,
              { owner, repo, commit_sha: branch, per_page: 100 }
            );
            commit = commitComments.length;

            // --- PR comments (if PR exists) ---
            let pr = context.payload.pull_request?.number;
            if (!pr) {
              const prs = await github.rest.pulls.list({
                owner, repo, head: `${owner}:${branch}`, state: 'open'
              });
              if (prs.data.length) pr = prs.data[0].number;
            }

            if (pr) {
              const issueComments = await github.paginate(
                github.rest.issues.listComments,
                { owner, repo, issue_number: pr, per_page: 100 }
              );
              const reviewComments = await github.paginate(
                github.rest.pulls.listReviewComments,
                { owner, repo, pull_number: pr, per_page: 100 }
              );
              issue = issueComments.length;
              review = reviewComments.length;
            }

            console.log({
              commit,
              issue,
              review,
              total: commit + issue + review
            });
