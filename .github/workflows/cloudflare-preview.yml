name: Count comments on current branch
on: workflow_dispatch
permissions:
  issues: read
  pull-requests: read

jobs:
  count-comments:
    runs-on: ubuntu-latest
    steps:
      - name: Count comments
        id: count
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUBTOKEN }}
          script: |
            const owner = context.repo.owner, repo = context.repo.repo;
            let prNumber = context.payload.pull_request?.number || null;
            if (!prNumber) {
              const branch = (context.ref || '').replace('refs/heads/', '');
              const pulls = await github.rest.pulls.list({ owner, repo, head: `${owner}:${branch}`, state: 'open', per_page: 100 });
              if (pulls.data.length) prNumber = pulls.data[0].number;
            }
            if (!prNumber) {
              core.setOutput('issue', '0'); core.setOutput('review', '0'); core.setOutput('total', '0');
              return;
            }
            const issueComments = await github.paginate(github.rest.issues.listComments, { owner, repo, issue_number: prNumber, per_page: 100 });
            const reviewComments = await github.paginate(github.rest.pulls.listReviewComments, { owner, repo, pull_number: prNumber, per_page: 100 });
            core.setOutput('issue', String(issueComments.length));
            core.setOutput('review', String(reviewComments.length));
            core.setOutput('total', String(issueComments.length + reviewComments.length));

      - name: Print totals
        run: |
          echo "Issue comments: ${{ steps.count.outputs.issue }}"
          echo "Review comments: ${{ steps.count.outputs.review }}"
          echo "Total comments: ${{ steps.count.outputs.total }}"
