name: Count PR + Commit comments (short)
on: workflow_dispatch

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  count:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        id: count
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const { owner, repo } = context.repo;
              const branch = context.payload.pull_request?.head?.ref || (context.ref || '').replace('refs/heads/','');
              const commits = await github.paginate(github.rest.repos.listCommits, { owner, repo, sha: branch, per_page: 100 });

              const commitComments = (await Promise.all(
                commits.map(c => github.paginate(github.rest.repos.listCommentsForCommit, { owner, repo, commit_sha: c.sha, per_page: 100 }))
              )).reduce((s, arr) => s + arr.length, 0);

              const prNumber = context.payload.pull_request?.number ||
                (await github.rest.pulls.list({ owner, repo, head: `${owner}:${branch}`, state: 'open', per_page: 1 })).data[0]?.number;

              const issueComments = prNumber
                ? (await github.paginate(github.rest.issues.listComments, { owner, repo, issue_number: prNumber, per_page: 100 })).length
                : 0;
              const reviewComments = prNumber
                ? (await github.paginate(github.rest.pulls.listReviewComments, { owner, repo, pull_number: prNumber, per_page: 100 })).length
                : 0;

              const total = commitComments + issueComments + reviewComments;
              core.setOutput('commit', String(commitComments));
              core.setOutput('issue', String(issueComments));
              core.setOutput('review', String(reviewComments));
              core.setOutput('total', String(total));
            } catch (e) {
              core.setOutput('commit','0'); core.setOutput('issue','0'); core.setOutput('review','0'); core.setOutput('total','0');
            }

      - name: Print totals
        run: |
          echo "Commit comments: ${{ steps.count.outputs.commit }}"
          echo "PR issue comments: ${{ steps.count.outputs.issue }}"
          echo "PR review comments: ${{ steps.count.outputs.review }}"
          echo "Total comments: ${{ steps.count.outputs.total }}"
