name: Cloudflare Preview (conditional PR & Commit comment)

on:
  workflow_dispatch:
  push:
    branches-ignore: [main]
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write
  issues: write
  pull-requests: write
  deployments: write

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout correct ref:
      #    - For PR: checkout PR source (head) branch
      #    - For push/dispatch: checkout pushed commit
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name || github.sha }}

      # 2) Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      # 3) Install deps
      - name: Install dependencies
        run: npm ci

      # 4) Build (static export) - adjust as needed
      - name: Build (static export)
        run: npm run build
        # next.config.ts must contain: export default { output: "export" }

      # 5) Deploy to Cloudflare Pages
      - name: Deploy to Cloudflare Pages
        id: cf
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ci-cd-static-page-preview
          directory: out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.head_ref || github.ref_name }}
          wranglerVersion: 4

      # 6) Compute stable preview URL (from source branch when available)
      - name: Compute stable preview URL
        id: url
        run: |
          BRANCH="${{ github.head_ref || github.ref_name || github.sha }}"
          SAFE=$(echo "$BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's#[^a-z0-9._-]#-#g')
          echo "url=https://${SAFE}.ci-cd-static-page-preview.pages.dev" >> $GITHUB_OUTPUT

      # 7) Count comments differently for PR vs push/dispatch
      - name: Count comments
        id: count
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const event = context.eventName;

            let commitCount = 0;
            let issueCount = 0;
            let reviewCount = 0;

            if (event === 'pull_request') {
              const pr = context.payload.pull_request.number;

              // Count PR issue comments
              issueCount = (await github.paginate(
                github.rest.issues.listComments,
                { owner, repo, issue_number: pr, per_page: 100 }
              )).length;

              // Count PR review comments (inline review comments)
              reviewCount = (await github.paginate(
                github.rest.pulls.listReviewComments,
                { owner, repo, pull_number: pr, per_page: 100 }
              )).length;

              // Count commit comments across commits in the PR
              const prCommits = await github.paginate(
                github.rest.pulls.listCommits,
                { owner, repo, pull_number: pr, per_page: 100 }
              );

              if (prCommits && prCommits.length) {
                const perCommitComments = await Promise.all(
                  prCommits.map(c =>
                    github.paginate(
                      github.rest.repos.listCommentsForCommit,
                      { owner, repo, commit_sha: c.sha, per_page: 100 }
                    )
                  )
                );
                commitCount = perCommitComments.reduce((s, a) => s + a.length, 0);
              } else {
                commitCount = 0;
              }
            } else {
              // push or workflow_dispatch: count comments on the single commit
              const sha = context.sha;
              const comments = await github.paginate(
                github.rest.repos.listCommentsForCommit,
                { owner, repo, commit_sha: sha, per_page: 100 }
              );
              commitCount = comments.length;
            }

            const total = commitCount + issueCount + reviewCount;

            core.setOutput('commit', String(commitCount));
            core.setOutput('issue', String(issueCount));
            core.setOutput('review', String(reviewCount));
            core.setOutput('total', String(total));

      # 8) Post PR comment ONLY when total == 0 (PR event)
      - name: Post PR preview comment (only once)
        if: ${{ github.event_name == 'pull_request' && steps.count.outputs.total == '0' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          # create-or-update will create a new comment here (there are zero PR comments)
          body: |
            ðŸš€ **Preview for `${{ github.head_ref || github.ref_name }}`**
            ðŸ”— ${{ steps.url.outputs.url }}

      # 9) Post commit comment ONLY when commit count == 0 (push or manual)
      - name: Post commit preview comment (only once)
        if: ${{ (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && steps.count.outputs.commit == '0' }}
        uses: peter-evans/commit-comment@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          sha: ${{ github.sha }}
          body: |
            ðŸš€ **Preview for `${{ github.ref_name || github.head_ref }}`**
            ðŸ”— ${{ steps.url.outputs.url }}

      # 10) Print totals for debugging
      - name: Print totals
        run: |
          echo "Commit comments: ${{ steps.count.outputs.commit }}"
          echo "PR issue comments: ${{ steps.count.outputs.issue }}"
          echo "PR review comments: ${{ steps.count.outputs.review }}"
          echo "Total comments: ${{ steps.count.outputs.total }}"
